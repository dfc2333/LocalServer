<html>
    <head>
        <script>
            document.addEventListener('DOMContentLoaded',function(){
                renderMsg()
                announce()
            })

            async function renderMsg(){
                MsgJson=await fetch('/message?targetuser='+document.getElementById('user').value+"&key="+encodeURIComponent(document.getElementById("key").value))
                MsgJson=await MsgJson.json()
                console.log(MsgJson)
                Msgcontainer=document.getElementById("MsgBox")
                for (e of MsgJson.content){
                    newmsg=crtMsg(e.sender,e.time,e.content)
                    Msgcontainer.appendChild(newmsg)
                }
                end=document.getElementById('end')
                end.scrollIntoView({behavious:"smooth"})
            }

            async function announce(){
                if (document.getElementById('user').value!=""){return}
                ann=await fetch('/announce')
                ann=await ann.json()
                console.log(ann)
                annc=document.getElementById('ann')
                annc.appendChild(crtMsg(ann.sender,ann.time,ann.content))
            }
            function crtMsg(sender,time,content){
                box=document.createElement('div')
                senderh=document.createElement('h2')
                timeh=document.createElement('p')
                contenth=document.createElement('p')
                senderh.textContent=sender
                timeh.textContent=time
                contenth.textContent=content
                box.appendChild(senderh)
                box.appendChild(timeh)
                box.appendChild(contenth)
                return box
            }
            async function sendMsg(){
                content=document.getElementById('content').value
                user=document.getElementById('user').value
                sth = await fetch('/sendmsg?content='+encodeURIComponent(content)+'&targetuser='+encodeURIComponent(user)+"&key="+encodeURIComponent(document.getElementById("key").value))
                console.log(await sth.text())
                clearmsg()
                await renderMsg()
            }
            function clearmsg(){
                box=document.getElementById('MsgBox')
                box.innerHTML=''
            }
            async function abc(){
                clearmsg()
                await renderMsg()
            }
        </script>
        <style>
            .scrollable{
                x:90%;
                overflow-y: auto;
                word-wrap: break-word;
            }
        </style>
    </head>
    <body>
        <h1>Talk</h1>
        <div id="ann" style="position: fixed;background-color: grey;"></div>
        <div id="MsgBox" class="scrollable"></div>
        <input type="text" id="content" placeholder="message...">
        <input type="text" id="user" placeholder="私聊对象，留空以在班级群发送">
        <label for="key">你和私聊对象商定的密钥，留空则使用默认</label>
        <input type="text" id="key" placeholder="密钥。。。">
        <button onclick="sendMsg()">send</button>
        <button onclick="abc()">刷新</button>
        <div id="end"></div>
    </body>
</html>